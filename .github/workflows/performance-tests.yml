name: Performance Tests

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'tests/performance/**'
      - '.github/workflows/performance-tests.yml'
  push:
    branches: [main, develop]
  schedule:
    # Run performance tests nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of performance test to run'
        required: true
        default: 'api'
        type: choice
        options:
          - api
          - load
          - stress
          - all

jobs:
  performance-test:
    name: Run Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - api-performance
          - load-test

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: llm_marketplace_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for baseline comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/performance/package-lock.json

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Install performance test dependencies
        working-directory: tests/performance
        run: npm ci

      - name: Start Elasticsearch
        run: |
          docker run -d \
            --name elasticsearch \
            -p 9200:9200 \
            -e "discovery.type=single-node" \
            -e "xpack.security.enabled=false" \
            -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
            docker.elastic.co/elasticsearch/elasticsearch:8.11.3

      - name: Start Kafka
        run: |
          docker run -d --name zookeeper -p 2181:2181 \
            -e ZOOKEEPER_CLIENT_PORT=2181 \
            confluentinc/cp-zookeeper:7.5.3

          sleep 10

          docker run -d --name kafka -p 9092:9092 \
            --link zookeeper \
            -e KAFKA_BROKER_ID=1 \
            -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
            -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
            -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
            confluentinc/cp-kafka:7.5.3

      - name: Wait for services to be ready
        run: |
          # Wait for Elasticsearch
          timeout 60 bash -c 'until curl -f http://localhost:9200/_cluster/health; do sleep 2; done'

          # Wait for Kafka
          sleep 20

      - name: Build service Docker images
        run: |
          docker build -t llm-marketplace/publishing:test ./services/publishing
          docker build -t llm-marketplace/discovery:test ./services/discovery
          docker build -t llm-marketplace/consumption:test ./services/consumption
          docker build -t llm-marketplace/admin:test ./services/admin

      - name: Start microservices
        run: |
          docker-compose -f tests/e2e/docker-compose.test.yml up -d
          sleep 30

      - name: Verify services are healthy
        run: |
          curl -f http://localhost:3001/health || exit 1
          curl -f http://localhost:3002/health || exit 1
          curl -f http://localhost:3003/health || exit 1
          curl -f http://localhost:3004/health || exit 1

      - name: Download baseline metrics
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: performance-baseline
          path: tests/performance/baselines/

      - name: Run performance tests - ${{ matrix.test-suite }}
        working-directory: tests/performance
        env:
          TEST_ENV: ci
          BASE_URL: http://localhost:3000
          PUBLISHING_SERVICE_URL: http://localhost:3001
          DISCOVERY_SERVICE_URL: http://localhost:3002
          CONSUMPTION_SERVICE_URL: http://localhost:3003
          ADMIN_SERVICE_URL: http://localhost:3004
        run: |
          if [ "${{ matrix.test-suite }}" == "api-performance" ]; then
            k6 run --out json=reports/api-performance-results.json scenarios/api-performance.js
          elif [ "${{ matrix.test-suite }}" == "load-test" ]; then
            k6 run --out json=reports/load-test-results.json scenarios/load-test.js
          fi

      - name: Compare with baseline
        if: always()
        working-directory: tests/performance
        env:
          RESULTS_FILE: reports/${{ matrix.test-suite }}-results.json
          BASELINE_FILE: baselines/baseline-${{ matrix.test-suite }}.json
          REGRESSION_THRESHOLD: 10
          FAIL_ON_REGRESSION: ${{ github.event_name == 'pull_request' }}
        run: |
          node scripts/compare-performance.js || true

      - name: Generate HTML report
        if: always()
        working-directory: tests/performance
        run: |
          npm run report || true

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-${{ matrix.test-suite }}
          path: |
            tests/performance/reports/
          retention-days: 30

      - name: Save baseline (on main branch)
        if: github.ref == 'refs/heads/main' && success()
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: tests/performance/reports/${{ matrix.test-suite }}-results.json

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparisonPath = 'tests/performance/reports/performance-comparison.json';

            if (!fs.existsSync(comparisonPath)) {
              console.log('No comparison report found');
              return;
            }

            const comparison = JSON.parse(fs.readFileSync(comparisonPath, 'utf8'));

            let comment = '## üìä Performance Test Results: ${{ matrix.test-suite }}\n\n';

            if (comparison.regressions.length > 0) {
              comment += '### ‚ö†Ô∏è Performance Regressions Detected\n\n';
              comment += '| Metric | Baseline | Current | Change |\n';
              comment += '|--------|----------|---------|--------|\n';
              comparison.regressions.forEach(reg => {
                comment += `| ${reg.metric} | ${reg.baseline.toFixed(2)}${reg.unit} | ${reg.current.toFixed(2)}${reg.unit} | ${reg.differencePercent > 0 ? '+' : ''}${reg.differencePercent.toFixed(2)}% |\n`;
              });
              comment += '\n';
            }

            if (comparison.improvements.length > 0) {
              comment += '### ‚ú® Performance Improvements\n\n';
              comment += '| Metric | Baseline | Current | Change |\n';
              comment += '|--------|----------|---------|--------|\n';
              comparison.improvements.forEach(imp => {
                comment += `| ${imp.metric} | ${imp.baseline.toFixed(2)}${imp.unit} | ${imp.current.toFixed(2)}${imp.unit} | ${imp.differencePercent > 0 ? '+' : ''}${imp.differencePercent.toFixed(2)}% |\n`;
              });
            }

            if (comparison.regressions.length === 0 && comparison.improvements.length === 0) {
              comment += '‚úÖ No significant performance changes detected.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs-${{ matrix.test-suite }}
          path: |
            tests/performance/logs/
          retention-days: 7

      - name: Collect Docker logs on failure
        if: failure()
        run: |
          mkdir -p tests/performance/logs
          docker-compose -f tests/e2e/docker-compose.test.yml logs > tests/performance/logs/docker-compose.log

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f tests/e2e/docker-compose.test.yml down -v
          docker stop elasticsearch kafka zookeeper || true
          docker rm elasticsearch kafka zookeeper || true

  performance-summary:
    name: Performance Test Summary
    needs: performance-test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.performance-test.result }}" == "success" ]; then
            echo "‚úÖ All performance tests passed"
            exit 0
          else
            echo "‚ö†Ô∏è Some performance tests had issues"
            exit 1
          fi

      - name: Post to Slack (on failure)
        if: failure() && github.ref == 'refs/heads/main'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Performance Tests Failed on main branch",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è Performance tests failed on `main` branch\n*Workflow:* ${{ github.workflow }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
